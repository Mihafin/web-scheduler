<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–≥–æ–≤ ‚Äî Web Scheduler</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #fafafa; }
      header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #fff; border-bottom: 1px solid #e5e7eb; }
      main { max-width: 960px; margin: 0 auto; padding: 16px; }
      .row { display: flex; align-items: center; gap: 8px; }
      .muted { color: #6b7280; font-size: 12px; }
      .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin:12px 0; }
      .tag-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
      .value-list { display:flex; flex-direction:column; gap:6px; margin:8px 0; }
      .color-dot { display:inline-block; width: 12px; height: 12px; border-radius: 50%; border:1px solid #d1d5db; margin-right:6px; vertical-align: middle; }
      input[type="text"]{ padding: 6px; }
      button { cursor: pointer; }
      /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
      @media (max-width: 768px){
        header { flex-direction: column; align-items: flex-start; gap: 6px; }
        main { padding: 12px; }
        .row { flex-wrap: wrap; }
        .tag-header { flex-direction: column; align-items: stretch; gap: 10px; }
        .tag-header .row { justify-content: space-between; }
        input[type="text"]{ width: 100%; }
        button { padding: 8px 10px; }
        .card { padding: 10px; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="row">
        <a href="/" style="text-decoration:none;">‚Üê –ù–∞–∑–∞–¥</a>
        <h3 style="margin:0;">–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–≥–æ–≤</h3>
      </div>
      <span class="muted">–°–æ–∑–¥–∞–Ω–∏–µ, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –∏ –∑–Ω–∞—á–µ–Ω–∏–π</span>
    </header>
    <main>
      <div class="row" style="margin-bottom:10px;">
        <input id="newTagName" type="text" placeholder="–ù–æ–≤—ã–π —Ç–µ–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–ª)" style="flex:1;"/>
        <button id="addTagBtn">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>
      </div>
      <div id="tagsPanel"></div>
    </main>

    <script>
      const API = '/api';

      async function fetchJSON(url, opts){
        const r = await fetch(url, opts);
        if(!r.ok){ throw new Error(await r.text()); }
        return r.json();
      }

      async function createTag(name, required, unique_resource){ return fetchJSON(`${API}/tags`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, required, unique_resource }) }); }
      async function updateTag(id, payload){ return fetchJSON(`${API}/tags/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); }
      async function deleteTag(id){ const r = await fetch(`${API}/tags/${id}`, { method:'DELETE' }); if(!r.ok) throw new Error(await r.text()); }
      async function createTagValue(tagId, value){ return fetchJSON(`${API}/tags/${tagId}/values`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({value}) }); }
      async function updateTagValue(id, value){ return fetchJSON(`${API}/tags/values/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({value}) }); }
      async function deleteTagValue(id){ const r = await fetch(`${API}/tags/values/${id}`, { method:'DELETE' }); if(!r.ok) throw new Error(await r.text()); }

      async function loadTagsWithValues(){
        const tags = await fetchJSON(`${API}/tags`);
        const result = [];
        for(const t of tags){
          const values = await fetchJSON(`${API}/tags/${t.id}/values`);
          result.push({ tag: t, values });
        }
        return result;
      }

      function renderTagsPanel(container, groups){
        container.innerHTML = '';
        for(const g of groups){
          const card = document.createElement('div');
          card.className = 'card';
          const head = document.createElement('div');
          head.className = 'tag-header';
          const left = document.createElement('div'); left.className = 'row';
          const nameSpan = document.createElement('strong'); nameSpan.textContent = g.tag.name;
          const reqWrap = document.createElement('label'); reqWrap.className='muted';
          const reqInput = document.createElement('input'); reqInput.type='checkbox'; reqInput.checked = !!g.tag.required; reqInput.style.marginLeft = '8px';
          reqWrap.appendChild(reqInput); reqWrap.appendChild(document.createTextNode(' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π'));
          reqInput.addEventListener('change', async ()=>{
            await updateTag(g.tag.id, { name: g.tag.name, required: reqInput.checked, unique_resource: !!g.tag.unique_resource });
            await refresh();
          });
          const uniqWrap = document.createElement('label'); uniqWrap.className='muted';
          const uniqInput = document.createElement('input'); uniqInput.type='checkbox'; uniqInput.checked = !!g.tag.unique_resource; uniqInput.style.marginLeft = '8px';
          uniqWrap.appendChild(uniqInput); uniqWrap.appendChild(document.createTextNode(' —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ—Å—É—Ä—Å'));
          uniqInput.addEventListener('change', async ()=>{
            await updateTag(g.tag.id, { name: g.tag.name, required: !!g.tag.required, unique_resource: uniqInput.checked });
            await refresh();
          });
          left.append(nameSpan, reqWrap, uniqWrap);
          const actions = document.createElement('div');
          const editBtn = document.createElement('button'); editBtn.textContent = '‚úé –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å';
          const delBtn = document.createElement('button'); delBtn.textContent = 'üóë –£–¥–∞–ª–∏—Ç—å';
          actions.append(editBtn, delBtn);
          head.append(left, actions);
          card.appendChild(head);

          const list = document.createElement('div'); list.className = 'value-list';
          for(const v of g.values){
            const row = document.createElement('div'); row.className = 'row';
            const color = document.createElement('input'); color.type='color'; color.value = v.color || '#9ca3af';
            const span = document.createElement('span'); span.textContent = v.value;
            const vb1 = document.createElement('button'); vb1.textContent = '‚úé';
            const vb2 = document.createElement('button'); vb2.textContent = 'üóë';
            color.addEventListener('change', async ()=>{
              await fetchJSON(`${API}/tags/values/${v.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ value: v.value, color: color.value }) });
              await refresh();
            });
            vb1.addEventListener('click', async ()=>{
              const nv = prompt('–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–≥–∞:', v.value);
              if(nv && nv !== v.value){ await fetchJSON(`${API}/tags/values/${v.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ value: nv, color: color.value }) }); await refresh(); }
            });
            vb2.addEventListener('click', async ()=>{
              if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–≥–∞?')){ await deleteTagValue(v.id); await refresh(); }
            });
            row.append(color, span, vb1, vb2);
            list.appendChild(row);
          }
          card.appendChild(list);

          const addRow = document.createElement('div'); addRow.className = 'row';
          const inp = document.createElement('input'); inp.type = 'text'; inp.placeholder = '–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ'; inp.style.flex = '1';
          const add = document.createElement('button'); add.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ';
          add.addEventListener('click', async ()=>{
            if(inp.value.trim()){ await createTagValue(g.tag.id, inp.value.trim()); inp.value=''; await refresh(); }
          });
          addRow.append(inp, add);
          card.appendChild(addRow);

          editBtn.addEventListener('click', async ()=>{
            const nn = prompt('–ù–æ–≤–æ–µ –∏–º—è —Ç–µ–≥–∞:', g.tag.name);
            if(nn === null) return;
            await updateTag(g.tag.id, { name: nn || g.tag.name, required: !!g.tag.required, unique_resource: !!g.tag.unique_resource });
            await refresh();
          });
          delBtn.addEventListener('click', async ()=>{
            if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ –∏ –≤—Å–µ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è?')){ await deleteTag(g.tag.id); await refresh(); }
          });

          container.appendChild(card);
        }
      }

      async function refresh(){
        const groups = await loadTagsWithValues();
        renderTagsPanel(document.getElementById('tagsPanel'), groups);
      }

      async function main(){
        // –î–æ–±–∞–≤–∏–º —Ñ–ª–∞–∂–∫–∏ —Ä—è–¥–æ–º —Å –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞, –µ—Å–ª–∏ –∏—Ö –µ—â—ë –Ω–µ—Ç
        const addRow = document.querySelector('main .row');
        if(addRow && !document.getElementById('newTagRequired')){
          const reqLabel = document.createElement('label'); reqLabel.className='muted';
          const req = document.createElement('input'); req.type='checkbox'; req.id='newTagRequired'; req.style.marginLeft='8px';
          reqLabel.appendChild(req); reqLabel.appendChild(document.createTextNode(' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π'));
          const uniqLabel = document.createElement('label'); uniqLabel.className='muted';
          const uniq = document.createElement('input'); uniq.type='checkbox'; uniq.id='newTagUnique'; uniq.style.marginLeft='8px';
          uniqLabel.appendChild(uniq); uniqLabel.appendChild(document.createTextNode(' —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ—Å—É—Ä—Å'));
          addRow.insertBefore(reqLabel, document.getElementById('addTagBtn'));
          addRow.insertBefore(uniqLabel, document.getElementById('addTagBtn'));
        }
        document.getElementById('addTagBtn').addEventListener('click', async ()=>{
          const name = document.getElementById('newTagName').value.trim();
          if(!name) return;
          const required = !!document.getElementById('newTagRequired')?.checked;
          const unique_resource = !!document.getElementById('newTagUnique')?.checked;
          await createTag(name, required, unique_resource);
          document.getElementById('newTagName').value='';
          if(document.getElementById('newTagRequired')) document.getElementById('newTagRequired').checked = false;
          if(document.getElementById('newTagUnique')) document.getElementById('newTagUnique').checked = false;
          await refresh();
        });
        await refresh();
      }

      main().catch(err => console.error(err));
    </script>
  </body>
  </html>


