<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
      #app { display: grid; grid-template-columns: 300px 1fr; min-height: 100vh; }
      aside { border-right: 1px solid #e5e7eb; padding: 12px; overflow: auto; }
      main { padding: 12px; }
      .tag-values { display: flex; flex-direction: column; gap: 6px; max-height: 40vh; overflow: auto; }
      .filters { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
      .section { margin-top: 16px; }
      .row { display: flex; align-items: center; gap: 6px; }
      .muted { color: #6b7280; font-size: 12px; }
      button { cursor: pointer; }
      input[type="text"], input[type="datetime-local"] { padding: 6px; }
      /* Modal */
      .hidden { display: none; }
      .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: flex; align-items: center; justify-content: center; z-index: 50; }
      .modal-backdrop.hidden { display: none !important; }
      .modal { background: #fff; border-radius: 8px; padding: 16px; width: 520px; max-width: calc(100% - 24px); box-shadow: 0 10px 30px rgba(0,0,0,.2); }
      .modal h3 { margin: 0 0 12px 0; }
      .modal .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .modal .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
      .tag-groups { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; max-height: 220px; overflow: auto; border: 1px solid #e5e7eb; padding: 8px; border-radius: 6px; }
      .tag-group { border: 1px dashed #e5e7eb; padding: 6px; border-radius: 6px; }
      .tag-group strong { font-size: 12px; color: #374151; }
      .tag-list, .value-list { display: flex; flex-direction: column; gap: 4px; margin: 6px 0; }
      .tag-header { display: flex; align-items: center; justify-content: space-between; gap: 6px; }
    </style>
  </head>
  <body>
    <div id="app">
      <aside>
        <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
        <div id="filters"></div>
        <button id="createBtn">+ –°–æ–±—ã—Ç–∏–µ</button>

        <div class="section">
          <h3>–¢–µ–≥–∏</h3>
          <div class="row" style="margin-bottom:8px;">
            <input id="newTagName" type="text" placeholder="–ù–æ–≤—ã–π —Ç–µ–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–ª)" style="flex:1;"/>
            <button id="addTagBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          <div id="tagsPanel"></div>
          <div class="muted">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å —Ç–µ–≥–∏ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è.</div>
        </div>
      </aside>
      <main>
        <div id="calendar"></div>
      </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–±—ã—Ç–∏—è -->
    <div id="eventModalWrap" class="modal-backdrop hidden">
      <div class="modal">
        <h3 id="eventModalTitle">–°–æ–±—ã—Ç–∏–µ</h3>
        <div class="grid">
          <div class="row"><input id="evTitle" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="width:100%"/></div>
          <div></div>
          <div>
            <label class="muted">–ù–∞—á–∞–ª–æ</label>
            <input id="evStart" type="datetime-local" style="width:100%"/>
          </div>
          <div>
            <label class="muted">–û–∫–æ–Ω—á–∞–Ω–∏–µ</label>
            <input id="evEnd" type="datetime-local" style="width:100%"/>
          </div>
          <div style="grid-column: 1 / -1;">
            <label class="muted">–ó–Ω–∞—á–µ–Ω–∏—è —Ç–µ–≥–æ–≤</label>
            <div id="evTagGroups" class="tag-groups"></div>
          </div>
        </div>
        <div class="actions">
          <button id="evDeleteBtn" style="margin-right:auto; color:#b91c1c;">–£–¥–∞–ª–∏—Ç—å</button>
          <button id="evCancelBtn">–û—Ç–º–µ–Ω–∞</button>
          <button id="evSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script>
      const API = '/api';

      async function fetchJSON(url, opts) {
        const res = await fetch(url, opts);
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      let TAG_GROUPS = [];
      let SELECTED = new Set();

      async function loadTagsWithValues() {
        const tags = await fetchJSON(`${API}/tags`);
        const result = [];
        for (const t of tags) {
          const values = await fetchJSON(`${API}/tags/${t.id}/values`);
          result.push({ tag: t, values });
        }
        TAG_GROUPS = result;
        return result;
      }

      function renderFilters(cont, groups, state) {
        cont.innerHTML = '';
        for (const g of groups) {
          const h = document.createElement('div');
          h.innerHTML = `<strong>${g.tag.name}</strong>`;
          cont.appendChild(h);
          const box = document.createElement('div');
          box.className = 'tag-values';
          for (const v of g.values) {
            const id = `tv-${v.id}`;
            const checked = state.has(v.id) ? 'checked' : '';
            const item = document.createElement('label');
            item.innerHTML = `<input type="checkbox" id="${id}" ${checked}/> ${v.value}`;
            item.querySelector('input').addEventListener('change', (e)=>{
              if (e.target.checked) state.add(v.id); else state.delete(v.id);
              window.calendar.refetchEvents();
            });
            box.appendChild(item);
          }
          cont.appendChild(box);
        }
      }

      // CRUD –¢–µ–≥–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏—è
      async function createTag(name){ return fetchJSON(`${API}/tags`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name}) }); }
      async function updateTag(id, name){ return fetchJSON(`${API}/tags/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name}) }); }
      async function deleteTag(id){ const r = await fetch(`${API}/tags/${id}`, { method:'DELETE' }); if(!r.ok) throw new Error(await r.text()); }
      async function createTagValue(tagId, value){ return fetchJSON(`${API}/tags/${tagId}/values`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({value}) }); }
      async function updateTagValue(id, value){ return fetchJSON(`${API}/tags/values/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({value}) }); }
      async function deleteTagValue(id){ const r = await fetch(`${API}/tags/values/${id}`, { method:'DELETE' }); if(!r.ok) throw new Error(await r.text()); }

      function renderTagsPanel(container, groups){
        container.innerHTML = '';
        for(const g of groups){
          const wrap = document.createElement('div');
          wrap.className = 'tag-group';
          const header = document.createElement('div');
          header.className = 'tag-header';
          const nameSpan = document.createElement('strong');
          nameSpan.textContent = g.tag.name;
          const actions = document.createElement('div');
          const editBtn = document.createElement('button'); editBtn.textContent = '‚úé';
          const delBtn = document.createElement('button'); delBtn.textContent = 'üóë';
          actions.append(editBtn, delBtn);
          header.append(nameSpan, actions);
          wrap.appendChild(header);

          const list = document.createElement('div');
          list.className = 'value-list';
          for(const v of g.values){
            const row = document.createElement('div');
            row.className = 'row';
            const span = document.createElement('span'); span.textContent = v.value;
            const vb1 = document.createElement('button'); vb1.textContent = '‚úé';
            const vb2 = document.createElement('button'); vb2.textContent = 'üóë';
            vb1.addEventListener('click', async ()=>{
              const nv = prompt('–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–≥–∞:', v.value);
              if(nv && nv !== v.value){ await updateTagValue(v.id, nv); await refreshTaxonomy(); }
            });
            vb2.addEventListener('click', async ()=>{
              if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–≥–∞?')){ await deleteTagValue(v.id); await refreshTaxonomy(); }
            });
            row.append(span, vb1, vb2);
            list.appendChild(row);
          }
          wrap.appendChild(list);

          const addRow = document.createElement('div');
          addRow.className = 'row';
          const inp = document.createElement('input'); inp.type = 'text'; inp.placeholder = '–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ'; inp.style.flex = '1';
          const add = document.createElement('button'); add.textContent = '+';
          add.addEventListener('click', async ()=>{
            if(inp.value.trim()){ await createTagValue(g.tag.id, inp.value.trim()); inp.value=''; await refreshTaxonomy(); }
          });
          addRow.append(inp, add);
          wrap.appendChild(addRow);

          editBtn.addEventListener('click', async ()=>{
            const nn = prompt('–ù–æ–≤–æ–µ –∏–º—è —Ç–µ–≥–∞:', g.tag.name);
            if(nn && nn !== g.tag.name){ await updateTag(g.tag.id, nn); await refreshTaxonomy(); }
          });
          delBtn.addEventListener('click', async ()=>{
            if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ –∏ –≤—Å–µ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è?')){ await deleteTag(g.tag.id); await refreshTaxonomy(); }
          });

          container.appendChild(wrap);
        }
      }

      async function refreshTaxonomy(){
        await loadTagsWithValues();
        renderFilters(document.getElementById('filters'), TAG_GROUPS, SELECTED);
        renderTagsPanel(document.getElementById('tagsPanel'), TAG_GROUPS);
        if(window.calendar) window.calendar.refetchEvents();
      }

      // –ú–û–î–ê–õ –°–û–ë–´–¢–ò–Ø
      function isoToLocalInputValue(iso){
        const d = new Date(iso);
        const pad = (n)=> String(n).padStart(2,'0');
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mi = pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }
      function localInputToIso(val){
        const d = new Date(val);
        return d.toISOString();
      }

      function renderTagCheckboxes(container, selectedIds){
        container.innerHTML = '';
        for(const g of TAG_GROUPS){
          const box = document.createElement('div');
          box.className = 'tag-group';
          const title = document.createElement('strong'); title.textContent = g.tag.name; box.appendChild(title);
          for(const v of g.values){
            const lab = document.createElement('label');
            const input = document.createElement('input'); input.type='checkbox'; input.value=String(v.id); input.checked = selectedIds.has(v.id);
            lab.appendChild(input); lab.appendChild(document.createTextNode(' '+v.value));
            box.appendChild(lab);
            box.appendChild(document.createElement('br'));
          }
          container.appendChild(box);
        }
      }

      function openEventModal(mode, data){
        const wrap = document.getElementById('eventModalWrap');
        const titleEl = document.getElementById('evTitle');
        const startEl = document.getElementById('evStart');
        const endEl = document.getElementById('evEnd');
        const groupsEl = document.getElementById('evTagGroups');
        const delBtn = document.getElementById('evDeleteBtn');
        const saveBtn = document.getElementById('evSaveBtn');
        const cancelBtn = document.getElementById('evCancelBtn');
        const modalTitle = document.getElementById('eventModalTitle');

        const selectedIds = new Set(data.tagValueIds || []);
        renderTagCheckboxes(groupsEl, selectedIds);

        titleEl.value = data.title || '';
        startEl.value = isoToLocalInputValue(data.startIso);
        endEl.value = isoToLocalInputValue(data.endIso);
        modalTitle.textContent = mode === 'create' ? '–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è';
        delBtn.style.display = mode === 'edit' ? 'inline-block' : 'none';

        const collectSelected = ()=> Array.from(groupsEl.querySelectorAll('input[type="checkbox"]:checked')).map(i=>Number(i.value));

        const onSave = async ()=>{
          const payload = {
            title: titleEl.value.trim(),
            dateFrom: localInputToIso(startEl.value),
            dateTo: localInputToIso(endEl.value),
            tagValueIds: collectSelected()
          };
          if(!payload.title){ alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
          if(mode==='create'){
            const ev = await fetchJSON(`${API}/schedules`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            window.calendar.addEvent({ id: String(ev.id), title: ev.title, start: ev.dateFrom, end: ev.dateTo, extendedProps:{ tagValueIds: ev.tagValueIds } });
          } else {
            const ev = await fetchJSON(`${API}/schedules/${data.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            const calEv = window.calendar.getEventById(String(data.id));
            if(calEv){ calEv.setProp('title', ev.title); calEv.setStart(ev.dateFrom); calEv.setEnd(ev.dateTo); calEv.setExtendedProp('tagValueIds', ev.tagValueIds); }
          }
          closeEventModal();
        };

        const onDelete = async ()=>{
          if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ?')){
            await fetch(`${API}/schedules/${data.id}`, { method:'DELETE' });
            const calEv = window.calendar.getEventById(String(data.id));
            if(calEv) calEv.remove();
            closeEventModal();
          }
        };

        const onCancel = ()=> closeEventModal();

        saveBtn.onclick = onSave;
        delBtn.onclick = onDelete;
        cancelBtn.onclick = onCancel;

        wrap.classList.remove('hidden');
      }

      function closeEventModal(){
        document.getElementById('eventModalWrap').classList.add('hidden');
      }

      async function main() {
        const filtersEl = document.getElementById('filters');
        SELECTED = new Set();
        await loadTagsWithValues();
        renderFilters(filtersEl, TAG_GROUPS, SELECTED);
        renderTagsPanel(document.getElementById('tagsPanel'), TAG_GROUPS);
        document.getElementById('addTagBtn').addEventListener('click', async ()=>{
          const name = document.getElementById('newTagName').value.trim();
          if(!name) return;
          await createTag(name);
          document.getElementById('newTagName').value='';
          await refreshTaxonomy();
        });

        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'timeGridWeek',
          headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
          locale: 'ru',
          selectable: true,
          editable: true,
          eventSources: [{
            events: async (info, success, failure) => {
              try {
                const params = new URLSearchParams();
                params.set('from', info.startStr);
                params.set('to', info.endStr);
                if (SELECTED.size) params.set('tag_value_ids', Array.from(SELECTED).join(','));
                const data = await fetchJSON(`${API}/schedules?${params}`);
                const events = data.map(e => ({ id: String(e.id), title: e.title, start: e.dateFrom, end: e.dateTo, extendedProps: { tagValueIds: e.tagValueIds } }));
                success(events);
              } catch (err) { failure(err); }
            }
          }],
          select: async (arg) => {
            openEventModal('create', { startIso: arg.startStr, endIso: arg.endStr, tagValueIds: Array.from(SELECTED) });
          },
          eventDrop: async (info) => {
            const ev = info.event;
            await fetchJSON(`${API}/schedules/${ev.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ dateFrom: ev.start.toISOString(), dateTo: ev.end?.toISOString() || ev.start.toISOString() }) });
          },
          eventResize: async (info) => {
            const ev = info.event;
            await fetchJSON(`${API}/schedules/${ev.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ dateFrom: ev.start.toISOString(), dateTo: ev.end?.toISOString() || ev.start.toISOString() }) });
          },
          eventClick: async (info) => {
            const ev = info.event;
            openEventModal('edit', { id: Number(ev.id), title: ev.title, startIso: ev.start.toISOString(), endIso: (ev.end?.toISOString() || ev.start.toISOString()), tagValueIds: ev.extendedProps?.tagValueIds || [] });
          }
        });
        calendar.render();
        window.calendar = calendar;

        document.getElementById('createBtn').addEventListener('click', async ()=>{
          const now = new Date();
          const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 0, 0).toISOString();
          const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 11, 0, 0).toISOString();
          openEventModal('create', { startIso: start, endIso: end, tagValueIds: Array.from(SELECTED) });
        });
      }

      main().catch(err => console.error(err));
    </script>
  </body>
  </html>


