<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
      #app { display: grid; grid-template-columns: 300px 1fr; min-height: 100vh; }
      aside { border-right: 1px solid #e5e7eb; padding: 12px; overflow: auto; }
      main { padding: 12px; }
      .tag-values { display: flex; flex-direction: column; gap: 6px; max-height: 40vh; overflow: auto; }
      .tag-line { display:flex; align-items:center; gap:6px; }
      .color-dot { display:inline-block; width: 10px; height: 10px; border-radius: 50%; border:1px solid #d1d5db; }
      .filters { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
      .section { margin-top: 16px; }
      .row { display: flex; align-items: center; gap: 6px; }
      .muted { color: #6b7280; font-size: 12px; }
      button { cursor: pointer; }
      input[type="text"], input[type="datetime-local"] { padding: 6px; }
      /* Modal */
      .hidden { display: none; }
      .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: flex; align-items: center; justify-content: center; z-index: 50; }
      .modal-backdrop.hidden { display: none !important; }
      .modal { background: #fff; border-radius: 8px; padding: 16px; width: 520px; max-width: calc(100% - 24px); box-shadow: 0 10px 30px rgba(0,0,0,.2); }
      .modal h3 { margin: 0 0 12px 0; }
      .modal .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .modal .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
      .tag-groups { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; max-height: 220px; overflow: auto; border: 1px solid #e5e7eb; padding: 8px; border-radius: 6px; }
      .tag-group { border: 1px dashed #e5e7eb; padding: 6px; border-radius: 6px; }
      .tag-group strong { font-size: 12px; color: #374151; }
      .tag-list, .value-list { display: flex; flex-direction: column; gap: 4px; margin: 6px 0; }
      .tag-header { display: flex; align-items: center; justify-content: space-between; gap: 6px; }
    </style>
  </head>
  <body>
    <div id="app">
      <aside>
        <div class="row" style="justify-content: space-between; align-items: baseline;">
          <h3 style="margin:0;">Фильтры</h3>
          <a href="/tags.html" class="muted">редактировать</a>
        </div>
        <div id="filters"></div>
        <button id="createBtn">+ Событие</button>
      </aside>
      <main>
        <div id="calendar"></div>
      </main>
    </div>

    <!-- Модальное окно события -->
    <div id="eventModalWrap" class="modal-backdrop hidden">
      <div class="modal">
        <h3 id="eventModalTitle">Событие</h3>
        <div class="grid">
          <div class="row"><input id="evTitle" type="text" placeholder="Название" style="width:100%"/></div>
          <div></div>
          <div>
            <label class="muted">Начало</label>
            <input id="evStart" type="datetime-local" style="width:100%"/>
          </div>
          <div>
            <label class="muted">Окончание</label>
            <input id="evEnd" type="datetime-local" style="width:100%"/>
          </div>
          <div style="grid-column: 1 / -1;">
            <label class="muted">Значения тегов</label>
            <div id="evTagGroups" class="tag-groups"></div>
          </div>
        </div>
        <div class="actions">
          <button id="evDeleteBtn" style="margin-right:auto; color:#b91c1c;">Удалить</button>
          <button id="evCancelBtn">Отмена</button>
          <button id="evSaveBtn">Сохранить</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script>
      const API = '/api';

      async function fetchJSON(url, opts) {
        const res = await fetch(url, opts);
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      // Глобальные состояния
      let TAG_GROUPS = [];
      let SELECTED = new Set();

      async function loadTagsWithValues() {
        const tags = await fetchJSON(`${API}/tags`);
        const result = [];
        for (const t of tags) {
          const values = await fetchJSON(`${API}/tags/${t.id}/values`);
          result.push({ tag: t, values });
        }
        TAG_GROUPS = result;
        return result;
      }

      function renderFilters(cont, groups, state) {
        cont.innerHTML = '';
        // Радио для выбора основного тега для подсветки (по умолчанию первый)
        const radioWrap = document.createElement('div'); radioWrap.className = 'tag-values';
        const radioTitle = document.createElement('div'); radioTitle.className='muted'; radioTitle.textContent = 'Основной тег для подсветки:';
        radioWrap.appendChild(radioTitle);
        const radioName = 'highlight-tag';
        if (!window.highlightTagId && groups.length) {
          window.highlightTagId = groups[0].tag.id;
        }
        for(const g of groups){
          const label = document.createElement('label'); label.className='tag-line';
          const checked = String(window.highlightTagId) === String(g.tag.id) ? 'checked' : '';
          label.innerHTML = `<input type="radio" name="${radioName}" value="${g.tag.id}" ${checked}/> ${g.tag.name}`;
          label.querySelector('input').addEventListener('change', ()=>{ window.highlightTagId = g.tag.id; if(window.calendar) window.calendar.refetchEvents(); });
          radioWrap.appendChild(label);
        }
        cont.appendChild(radioWrap);
        // Чекбоксы для фильтрации по значениям
        for (const g of groups) {
          const h = document.createElement('div');
          h.innerHTML = `<strong>${g.tag.name}</strong>`;
          cont.appendChild(h);
          const box = document.createElement('div');
          box.className = 'tag-values';
          for (const v of g.values) {
            const id = `tv-${v.id}`;
            const checked = state.has(v.id) ? 'checked' : '';
            const item = document.createElement('label');
            item.innerHTML = `<input type="checkbox" id="${id}" ${checked}/> ${v.value}`;
            item.querySelector('input').addEventListener('change', (e)=>{
              if (e.target.checked) state.add(v.id); else state.delete(v.id);
              window.calendar.refetchEvents();
            });
            box.appendChild(item);
          }
          cont.appendChild(box);
        }
      }

      // Управление тегами вынесено на /tags.html. На главной оставлены только фильтры.

      // МОДАЛ СОБЫТИЯ
      function isoToLocalInputValue(iso){
        const d = new Date(iso);
        const pad = (n)=> String(n).padStart(2,'0');
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mi = pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }
      function localInputToIso(val){
        const d = new Date(val);
        return d.toISOString();
      }

      function renderTagCheckboxes(container, selectedIds){
        container.innerHTML = '';
        for(const g of TAG_GROUPS){
          const box = document.createElement('div');
          box.className = 'tag-group';
          const title = document.createElement('strong'); title.textContent = g.tag.name; box.appendChild(title);
          for(const v of g.values){
            const lab = document.createElement('label');
            const input = document.createElement('input'); input.type='checkbox'; input.value=String(v.id); input.checked = selectedIds.has(v.id);
            lab.appendChild(input); lab.appendChild(document.createTextNode(' '+v.value));
            box.appendChild(lab);
            box.appendChild(document.createElement('br'));
          }
          container.appendChild(box);
        }
      }

      function openEventModal(mode, data){
        const wrap = document.getElementById('eventModalWrap');
        const titleEl = document.getElementById('evTitle');
        const startEl = document.getElementById('evStart');
        const endEl = document.getElementById('evEnd');
        const groupsEl = document.getElementById('evTagGroups');
        const delBtn = document.getElementById('evDeleteBtn');
        const saveBtn = document.getElementById('evSaveBtn');
        const cancelBtn = document.getElementById('evCancelBtn');
        const modalTitle = document.getElementById('eventModalTitle');

        const selectedIds = new Set(data.tagValueIds || []);
        renderTagCheckboxes(groupsEl, selectedIds);

        titleEl.value = data.title || '';
        startEl.value = isoToLocalInputValue(data.startIso);
        endEl.value = isoToLocalInputValue(data.endIso);
        modalTitle.textContent = mode === 'create' ? 'Создание события' : 'Редактирование события';
        delBtn.style.display = mode === 'edit' ? 'inline-block' : 'none';

        const collectSelected = ()=> Array.from(groupsEl.querySelectorAll('input[type="checkbox"]:checked')).map(i=>Number(i.value));

        const onSave = async ()=>{
          const payload = {
            title: titleEl.value.trim(),
            dateFrom: localInputToIso(startEl.value),
            dateTo: localInputToIso(endEl.value),
            tagValueIds: collectSelected()
          };
          if(!payload.title){ alert('Введите название'); return; }
          if(mode==='create'){
            const ev = await fetchJSON(`${API}/schedules`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            window.calendar.addEvent({ id: String(ev.id), title: ev.title, start: ev.dateFrom, end: ev.dateTo, extendedProps:{ tagValueIds: ev.tagValueIds } });
          } else {
            const ev = await fetchJSON(`${API}/schedules/${data.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            const calEv = window.calendar.getEventById(String(data.id));
            if(calEv){ calEv.setProp('title', ev.title); calEv.setStart(ev.dateFrom); calEv.setEnd(ev.dateTo); calEv.setExtendedProp('tagValueIds', ev.tagValueIds); }
          }
          closeEventModal();
        };

        const onDelete = async ()=>{
          if(confirm('Удалить событие?')){
            await fetch(`${API}/schedules/${data.id}`, { method:'DELETE' });
            const calEv = window.calendar.getEventById(String(data.id));
            if(calEv) calEv.remove();
            closeEventModal();
          }
        };

        const onCancel = ()=> closeEventModal();

        saveBtn.onclick = onSave;
        delBtn.onclick = onDelete;
        cancelBtn.onclick = onCancel;

        wrap.classList.remove('hidden');
      }

      function closeEventModal(){
        document.getElementById('eventModalWrap').classList.add('hidden');
      }

      async function main() {
        const filtersEl = document.getElementById('filters');
        SELECTED = new Set();
        await loadTagsWithValues();
        if (!window.highlightTagId && TAG_GROUPS.length) {
          window.highlightTagId = TAG_GROUPS[0].tag.id;
        }
        renderFilters(filtersEl, TAG_GROUPS, SELECTED);

        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'timeGridWeek',
          headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
          locale: 'ru',
          selectable: true,
          editable: true,
          eventSources: [{
            events: async (info, success, failure) => {
              try {
                const params = new URLSearchParams();
                params.set('from', info.startStr);
                params.set('to', info.endStr);
                if (SELECTED.size) params.set('tag_value_ids', Array.from(SELECTED).join(','));
                const data = await fetchJSON(`${API}/schedules?${params}`);
                const events = data.map(e => ({ id: String(e.id), title: e.title, start: e.dateFrom, end: e.dateTo, extendedProps: { tagValueIds: e.tagValueIds } }));
                // Раскраска по выбранному тегу: цвет берём у значения; иначе серый
                const hlTagId = window.highlightTagId || null;
                if(hlTagId){
                  const tvColorMap = new Map();
                  for(const g of TAG_GROUPS){
                    if(g.tag.id === hlTagId){
                      for(const v of g.values){ tvColorMap.set(v.id, v.color || '#9ca3af'); }
                    }
                  }
                  for(const ev of events){
                    const tvIds = ev.extendedProps.tagValueIds || [];
                    let chosenColor = null;
                    for(const id of tvIds){ if(tvColorMap.has(id)){ chosenColor = tvColorMap.get(id); break; } }
                    const color = chosenColor || '#9ca3af';
                    ev.backgroundColor = color; ev.borderColor = color; ev.textColor = '#fff';
                  }
                }
                success(events);
              } catch (err) { failure(err); }
            }
          }],
          select: async (arg) => {
            openEventModal('create', { startIso: arg.startStr, endIso: arg.endStr, tagValueIds: Array.from(SELECTED) });
          },
          eventDrop: async (info) => {
            const ev = info.event;
            await fetchJSON(`${API}/schedules/${ev.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ dateFrom: ev.start.toISOString(), dateTo: ev.end?.toISOString() || ev.start.toISOString() }) });
          },
          eventResize: async (info) => {
            const ev = info.event;
            await fetchJSON(`${API}/schedules/${ev.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ dateFrom: ev.start.toISOString(), dateTo: ev.end?.toISOString() || ev.start.toISOString() }) });
          },
          eventClick: async (info) => {
            const ev = info.event;
            openEventModal('edit', { id: Number(ev.id), title: ev.title, startIso: ev.start.toISOString(), endIso: (ev.end?.toISOString() || ev.start.toISOString()), tagValueIds: ev.extendedProps?.tagValueIds || [] });
          }
        });
        calendar.render();
        window.calendar = calendar;

        document.getElementById('createBtn').addEventListener('click', async ()=>{
          const now = new Date();
          const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 0, 0).toISOString();
          const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 11, 0, 0).toISOString();
          openEventModal('create', { startIso: start, endIso: end, tagValueIds: Array.from(SELECTED) });
        });
      }

      main().catch(err => console.error(err));
    </script>
  </body>
  </html>


