<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Отчеты — Web Scheduler</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #fafafa; }
      header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #fff; border-bottom: 1px solid #e5e7eb; }
      main { max-width: 1000px; margin: 0 auto; padding: 16px; }
      .row { display: flex; align-items: center; gap: 8px; }
      .muted { color: #6b7280; font-size: 12px; }
      .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
      .tags { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; }
      .filters { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 8px; margin-top: 8px; }
      .tag-values { display: flex; flex-direction: column; gap: 6px; }
      .btn { padding: 8px 12px; border: 1px solid #e5e7eb; background: #111827; color: #fff; border-radius: 6px; cursor: pointer; }
      .btn.secondary { background: #fff; color: #111827; }
      .report { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; }
      .day { margin: 12px 0; }
      .day h3 { margin: 0 0 6px 0; font-size: 16px; }
      .event { margin-left: 18px; }
      .controls { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
      input[type="date"] { padding: 6px 8px; }
      @media print {
        header, .panel .controls, .panel .tags, .panel .muted, .panel #filters, .panel #filtersHeader, .panel #actionsRow { display: none !important; }
        body { background: #fff; }
        .report { border: 0; padding: 0; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="row">
        <a href="/" style="text-decoration:none;">← На главную</a>
        <h3 style="margin:0;">Отчеты</h3>
      </div>
      <span class="muted">Сформируйте PDF через печать</span>
    </header>
    <main>
      <div class="panel">
        <div class="controls">
          <label>С:
            <input id="fromDate" type="date" />
          </label>
          <label>По:
            <input id="toDate" type="date" />
          </label>
          <a href="#" id="thisWeek" class="muted" style="text-decoration:none;">текущая неделя</a>
          <a href="#" id="nextWeek" class="muted" style="text-decoration:none;">следующая неделя</a>
        </div>
        <div class="muted" style="margin-top:8px;">Выберите теги, значения которых нужно выводить в каждой строке события</div>
        <div id="tags" class="tags" style="margin-top:8px;"></div>
        <hr style="margin:12px 0; border:none; border-top:1px solid #e5e7eb;"/>
        <div id="filtersHeader" class="row" style="align-items: baseline; gap: 12px; margin-bottom: 6px;">
          <strong>Фильтры событий</strong>
          <label class="row" style="gap:6px;">
            <input id="showCanceled" type="checkbox"/>
            <span class="muted">Показывать отмененные</span>
          </label>
        </div>
        <div id="filters" class="filters"></div>
        <div id="actionsRow" class="row" style="margin-top: 8px;">
          <button id="gen" class="btn">Сгенерировать</button>
          <button id="print" class="btn secondary">Печать PDF</button>
        </div>
      </div>
      <div id="report" class="report"></div>
    </main>

    <script>
      const API = '/api';

      async function fetchJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }

      const WEEKDAYS = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
      function pad(n){ return String(n).padStart(2,'0'); }
      function fmtDay(d){ return `${WEEKDAYS[d.getDay()]}. ${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`; }
      function parseISO(s){ return new Date(s); }
      function startOfDayLocalISO(d){ const x = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); return x.toISOString(); }
      function nextDayStartLocalISO(d){ const x = new Date(d.getFullYear(), d.getMonth(), d.getDate()+1, 0,0,0,0); return x.toISOString(); }
      function hhmmLocal(iso){ const d=new Date(iso); return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }

      let TAG_GROUPS = [];
      let SELECTED_TAG_IDS = new Set(); // какие теги выводить значениями в отчёте
      let SELECTED_VALUE_IDS = new Set(); // фильтр по значениям тегов
      let SHOW_CANCELED = false;
      const tagValueIdToValue = new Map();
      const tagValueIdToTagId = new Map();
      const tagIdToName = new Map();

      async function loadTags(){
        const tags = await fetchJSON(`${API}/tags`);
        const container = document.getElementById('tags');
        container.innerHTML='';
        const filtersEl = document.getElementById('filters');
        filtersEl.innerHTML='';
        TAG_GROUPS = [];
        for(const t of tags){
          tagIdToName.set(t.id, t.name);
          const values = await fetchJSON(`${API}/tags/${t.id}/values`);
          TAG_GROUPS.push({ tag: t, values });
          for(const v of values){ tagValueIdToValue.set(v.id, v.value); tagValueIdToTagId.set(v.id, t.id); }
          const item = document.createElement('label');
          item.className = 'row';
          const cb = document.createElement('input'); cb.type='checkbox'; cb.value = String(t.id);
          cb.addEventListener('change', (e)=>{ if(e.target.checked) SELECTED_TAG_IDS.add(t.id); else SELECTED_TAG_IDS.delete(t.id); });
          item.appendChild(cb);
          item.appendChild(document.createTextNode(' '+t.name));
          container.appendChild(item);

          // Фильтры по значениям этого тега
          const box = document.createElement('div');
          box.className = 'tag-values';
          const title = document.createElement('div'); title.innerHTML = `<strong>${t.name}</strong>`; box.appendChild(title);
          for(const v of values){
            const lab = document.createElement('label');
            const iv = document.createElement('input'); iv.type='checkbox'; iv.value=String(v.id);
            iv.addEventListener('change', (e)=>{ const id = Number(v.id); if(e.target.checked) SELECTED_VALUE_IDS.add(id); else SELECTED_VALUE_IDS.delete(id); });
            lab.appendChild(iv);
            lab.appendChild(document.createTextNode(' '+v.value));
            box.appendChild(lab);
          }
          filtersEl.appendChild(box);
        }
        const showCanceledChk = document.getElementById('showCanceled');
        showCanceledChk.checked = SHOW_CANCELED;
        showCanceledChk.addEventListener('change', (e)=>{ SHOW_CANCELED = !!e.target.checked; });
      }

      function groupByDay(sortedEvents){
        const groups = new Map(); // key ISO day (local start)
        for(const ev of sortedEvents){
          const d = new Date(ev.dateFrom);
          const key = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0).toISOString();
          if(!groups.has(key)) groups.set(key, []);
          groups.get(key).push(ev);
        }
        return groups;
      }

      function renderReport(data){
        const mount = document.getElementById('report');
        mount.innerHTML = '';
        // sort by time_from then id
        data.sort((a,b)=>{
          const ta = new Date(a.dateFrom).getTime();
          const tb = new Date(b.dateFrom).getTime();
          if(ta !== tb) return ta - tb;
          return a.id - b.id;
        });
        const groups = groupByDay(data);
        const keys = Array.from(groups.keys()).sort();
        for(const dayIso of keys){
          const day = new Date(dayIso);
          const wrap = document.createElement('div'); wrap.className = 'day';
          const h = document.createElement('h3'); h.textContent = fmtDay(day); wrap.appendChild(h);
          const list = document.createElement('div');
          for(const ev of groups.get(dayIso)){
            const from = hhmmLocal(ev.dateFrom); const to = hhmmLocal(ev.dateTo);
            // собрать список значений выбранных тегов (без названий тегов)
            const valuesFlat = [];
            for(const tvId of ev.tagValueIds){
              const tagId = tagValueIdToTagId.get(tvId);
              if(!SELECTED_TAG_IDS.has(tagId)) continue;
              const value = tagValueIdToValue.get(tvId);
              if(value) valuesFlat.push(value);
            }
            const tail = valuesFlat.length ? `, ${valuesFlat.join(', ')}` : '';
            const line = document.createElement('div'); line.className = 'event';
            line.textContent = `- ${from}-${to}: ${ev.title}${tail}`;
            list.appendChild(line);
          }
          wrap.appendChild(list);
          mount.appendChild(wrap);
        }
      }

      async function generate(){
        const f = document.getElementById('fromDate').value;
        const t = document.getElementById('toDate').value;
        if(!f || !t){ alert('Укажите даты С и По'); return; }
        const fd = new Date(f); const td = new Date(t);
        if(td < fd){ alert('Дата По не может быть меньше даты С'); return; }
        const fromIso = startOfDayLocalISO(fd);
        const toIso = nextDayStartLocalISO(td); // полуоткрытый интервал
        const params = new URLSearchParams();
        params.set('from', fromIso); params.set('to', toIso);
        if(SELECTED_VALUE_IDS.size){ params.set('tag_value_ids', Array.from(SELECTED_VALUE_IDS).join(',')); }
        let rows = await fetchJSON(`${API}/schedules?${params}`);
        if(!SHOW_CANCELED){ rows = rows.filter(r => !r.isCanceled); }
        renderReport(rows);
      }

      document.getElementById('gen').addEventListener('click', generate);
      document.getElementById('print').addEventListener('click', ()=> window.print());
      document.getElementById('thisWeek').addEventListener('click', (e)=>{
        e.preventDefault();
        const now = new Date();
        const monday = new Date(now); monday.setDate(now.getDate() - ((now.getDay()+6)%7));
        const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
        const fromInput = document.getElementById('fromDate');
        const toInput = document.getElementById('toDate');
        fromInput.value = `${monday.getFullYear()}-${pad(monday.getMonth()+1)}-${pad(monday.getDate())}`;
        toInput.value = `${sunday.getFullYear()}-${pad(sunday.getMonth()+1)}-${pad(sunday.getDate())}`;
      });
      document.getElementById('nextWeek').addEventListener('click', (e)=>{
        e.preventDefault();
        const now = new Date();
        const monday = new Date(now); monday.setDate(now.getDate() - ((now.getDay()+6)%7) + 7);
        const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
        const fromInput = document.getElementById('fromDate');
        const toInput = document.getElementById('toDate');
        fromInput.value = `${monday.getFullYear()}-${pad(monday.getMonth()+1)}-${pad(monday.getDate())}`;
        toInput.value = `${sunday.getFullYear()}-${pad(sunday.getMonth()+1)}-${pad(sunday.getDate())}`;
      });

      // Инициализация
      (async () => {
        // Подставить текущую неделю по умолчанию
        const now = new Date();
        const monday = new Date(now); monday.setDate(now.getDate() - ((now.getDay()+6)%7));
        const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
        const fromInput = document.getElementById('fromDate');
        const toInput = document.getElementById('toDate');
        fromInput.value = `${monday.getFullYear()}-${pad(monday.getMonth()+1)}-${pad(monday.getDate())}`;
        toInput.value = `${sunday.getFullYear()}-${pad(sunday.getMonth()+1)}-${pad(sunday.getDate())}`;
        await loadTags();
      })().catch(console.error);
    </script>
  </body>
  </html>


