<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audit Logs</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #fafafa; }
        header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #fff; border-bottom: 1px solid #e5e7eb; }
        .row { display: flex; align-items: center; gap: 8px; }
        .muted { color: #6b7280; font-size: 12px; }
        main { max-width: 1200px; margin: 0 auto; padding: 16px; }
        input[type=number] { width: 80px; padding: 6px 8px; }
        button { padding: 6px 12px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; background: #fff; }
        th, td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
        th { background: #fafafa; position: sticky; top: 0; }
        .mono { font-family: ui-monospace, Menlo, Monaco, Consolas, monospace; }
        .wrap { white-space: pre-wrap; word-break: break-word; }
    </style>
</head>
<body>
    <header>
        <div class="row">
            <a href="/" style="text-decoration:none;">← На главную</a>
            <h3 style="margin:0;">Журнал действий</h3>
        </div>
        <span class="muted">Действия за последние N дней</span>
    </header>

    <main>
    <div class="row" style="gap:12px; margin-bottom:12px;">
        <label class="row muted">за <input id="days" type="number" min="1" max="365" value="2" /> дн.</label>
        <button id="reload">Обновить</button>
    </div>

    <table id="logs-table">
        <thead>
            <tr>
                <th>Время (локальное)</th>
                <th>Пользователь</th>
                <th>Действие</th>
                <th>Сущность</th>
                <th>ID</th>
                <th>Детали</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    </main>

    <script>
        async function loadLogs() {
            const days = Number(document.getElementById('days').value) || 2;
            const res = await fetch(`/api/audit?days=${encodeURIComponent(days)}`);
            if (!res.ok) {
                alert('Ошибка загрузки лога');
                return;
            }
            const data = await res.json();
            const tbody = document.querySelector('#logs-table tbody');
            tbody.innerHTML = '';
            for (const row of data) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="mono">${formatLocal(row.ts)}</td>
                    <td>${escapeHtml(row.username || '')}</td>
                    <td>${escapeHtml(row.action || '')}</td>
                    <td>${escapeHtml(row.entity || '')}</td>
                    <td class="mono">${row.entityId ?? ''}</td>
                    <td class="wrap">${escapeHtml(row.details || '')}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function formatLocal(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            if (isNaN(d)) return escapeHtml(iso);
            // Localized date & time with seconds
            return d.toLocaleString(undefined, {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        document.getElementById('reload').addEventListener('click', loadLogs);
        loadLogs();
    </script>
</body>
<!--
  This page lists audit entries recorded by the backend. Nginx sets X-Remote-User.
-->
</html>


